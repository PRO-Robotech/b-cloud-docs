---
id: etcd-architecture
---
import {getBasePrefix} from '@site/src/utils/getBasePrefix'

# Архитектура

## Введение

Архитектура развертывания ETCD-кластера играет решающую роль в обеспечении надежности, производительности и масштабируемости системы. Правильно спроектированный и развернутый ETCD-кластер способен выдерживать отказ отдельных узлов без потери данных и производительности, обеспечивая при этом высокую степень согласованности данных между узлами.

В данном разделе мы подробно рассмотрим кластер с трех точек зрения:

1. Сетевое развертывание:

   - Синхронизация данных между инстанциями
   - Операции чтения и записи данных
   - Мониторинг системы

2. Обслуживание базы данных

3. Управление сертификатами

## Сетевая схема развертывания

### Чтение/Запись

_Чтение_ - Если запрос на чтение поступает на любой узел кластера, он может быть обслужен непосредственно этим узлом, особенно если это сериализуемое чтение, которое обеспечивает высокую производительность с определенной степенью согласованности.

:::info
Для линейризуемого чтения, обеспечивающего сильную консистентность, узел может связаться с узлом (Leader) по сети 2380/TCP, чтобы убедиться в актуальности данных.
:::

_Запись_ - Все операции записи должны быть обработаны узлом (Leader) кластера для обеспечения согласованности данных через алгоритм консенсуса Raft.

:::info
Если запрос на запись поступает на узлы (Follower), эти узелы автоматически перенаправляет запрос на узел (Leader).
:::

<div className="center">
  <img src={`${getBasePrefix()}img/etcd/etcd-server.svg`} />
</div>

### Синхронизация

Когда происходит операция записи, узел (Leader) обрабатывает её и распространяет изменения на остальные узлы (Followers) кластера, сохраняя согласованность данных. Для репликации узлы взаимодействуют между собой по сети через порт 2380/TCP.

<div className="center">
  <img src={`${getBasePrefix()}img/etcd/etcd-peer.svg`} />
</div>

### Метрики

Порт метрик ETCD — это сетевой порт, на котором etcd предоставляет метрики о своём состоянии и производительности. Используется для мониторинга и анализа работы кластера с помощью инструментов наблюдения.

<div className="center">
  <img src={`${getBasePrefix()}img/etcd/etcd-metrics.svg`} />
</div>

## Обслуживание

Обслуживание кластера etcd включает в себя несколько важных аспектов, обеспечивающих стабильную и надёжную работу системы:

1. Создание снимков состояния базы данных (snapshots): Регулярное создание резервных копий данных etcd критически важно для восстановления в случае сбоя. Снимки могут быть полными, содержащими все данные кластера на момент создания, или инкрементными, включающими только изменения с момента последнего снимка. Это позволяет эффективно управлять резервными копиями и уменьшать объём хранимых данных.

2. Компакция (Compaction): В процессе работы etcd накапливает исторические версии данных из-за характерной для него многоверсийности. Компакция удаляет устаревшие версии ключей, уменьшая логический размер базы данных. Это снижает нагрузку на операции чтения и записи, повышая производительность кластера.

3. Дефрагментация (Defragmentation): После компакции физическое дисковое пространство может оставаться фрагментированным. Дефрагментация перераспределяет данные на диске, устраняя фрагментацию и сокращая фактический размер файлов базы данных. Это повышает эффективность использования дискового пространства и улучшает скорость доступа к данным.

:::info
Для выполнения этих рутинных задач рекомендуем использовать [Gardener ETCD Backup-Restore](https://github.com/gardener/etcd-backup-restore/tree/master)
:::

<div className="center">
  <img src={`${getBasePrefix()}img/etcd/etcd-backup.svg`} />
</div>

## Управление сертификатами

Ротация сертификатов (Certificate Rotation): Для поддержания безопасности и работоспособности кластера необходимо регулярно обновлять сертификаты. Это включает перевыпуск сертификатов узлов (peer certificates), клиентских сертификатов (client certificates), серверных сертификатов (server certificates), а при необходимости и сертификатов центра сертификации (ЦА certificates). Регулярная ротация сертификатов предотвращает потенциальные уязвимости и обеспечивает актуальность механизмов шифрования и аутентификации.

<div className="center">
  <img src={`${getBasePrefix()}img/etcd/etcd-certificates.svg`} />
</div>

:::warning
Просьба обратить внимание, что все сертификаты на всех узлах кластера выписаны единым (Center Authority) сертификатом
:::
