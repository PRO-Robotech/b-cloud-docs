---
id: base-load-balancer-metallb
---

import TabItem from '@theme/TabItem'
import Tabs from '@theme/Tabs'
import MetallbL2Announce from '@site/docs/tech-docs/kubernetes-network/metallb/metallb-ip-address-pool.mdx'
import L2Advertisement from '@site/docs/tech-docs/kubernetes-network/metallb/metallb-l2-advertisement.mdx'
import {getBasePrefix} from '@site/src/utils/getBasePrefix'

# LoadBalancer Metallb

## Обзор

`MetalLB` — это балансировщик нагрузки для кластеров Kubernetes, который предоставляет поддержку сервисов типа **LoadBalancer** в средах, где отсутствуют внешние облачные провайдеры с встроенными решениями для балансировки. MetalLB интегрируется с существующей сетевой инфраструктурой и использует стандартные протоколы маршрутизации для распределения трафика.

## Архитектура

`MetalLB` состоит из двух основных компонентов, которые совместно обеспечивают работу балансировщика нагрузки в кластере Kubernetes:

### Контроллер (Controller)

#### Функции:

- Выделяет сервисам типа `LoadBalancer` IP-адрес из заранее определенного пула адресов.
- Следит за изменениями в сервисах Kubernetes через API-сервер.
- Обновляет статус сервисов с информацией о назначенных им IP-адресах.
- Обновляет состояние ресурсов типа `servicel2statuses.metallb.io`

#### Особенности:

- Развертывается в качестве пода в кластере Kubernetes.
- Взаимодействует с API-сервером Kubernetes для получения актуальной информации о сервисах и эндпойнтах.
- Обеспечивает устойчивость к отказам благодаря механизму `Leader election` для координации между экземплярами контроллера.

### Спикер (Speaker)

#### Функции:

- Спикер отвечает за публикацию выделенных IP-адресов в сеть с использованием протоколов маршрутизации.
- Обеспечивает доступность сервисов извне кластера, отправляя запросы GARP
- Обеспечивает доступность сервисов извне кластера, объявляя маршруты через BGP.

## Режимы Работы

`MetalLB` поддерживает два основных режима работы, обеспечивая гибкость и совместимость с различными сетевыми средами:

<Tabs>
    <TabItem value='L2 Режим'>

    **GARP** — это метод передачи информации о соответствии определённого MAC-адреса определённому IP-адресу. Работает как пуш модель, уведомляя всю сеть о своем присутствии.

    <div className="center"> <img src={`${getBasePrefix()}img/network/garp.drawio.svg`} /></div>

    #### Описание:
    - В этом режиме спикеры отправляют GARP-запросы для объявленных IP-адресов.

    #### Особенности:
    - Подходит для простых сетевых конфигураций, где кластер находится в одной локальной сети (L2-домене).
    - Не требует сложной сетевой настройки.
    - Легко интегрируется в существующие сети.

    </TabItem>
    {/* <TabItem value='BGP Режим'>
    #### Описание:
    - В этом режиме спикеры объявляют IP-адреса сервисов через протокол BGP к внешним маршрутизаторам.

    #### Особенности:
    - Позволяет более гибко управлять маршрутизацией и масштабировать кластер в больших сетевых инфраструктурах.
    - Требует поддержки BGP на сетевом оборудовании.
    - Поддерживает множество настроек для сложных сетевых топологий.

    </TabItem> */}

</Tabs>

## Настройка и Работа

1. **Конфигурация Пула IP-адресов:**

- Администратор кластера определяет диапазон IP-адресов, который будет использоваться MetalLB.
- Этот диапазон не должен использоваться другими устройствами в сети.

2. **Установка MetalLB:**

- Развертывание осуществляется с помощью YAML-манифестов.
- После установки компоненты контроллера и спикера запускаются в кластере.

3. **Настройка Протоколов Маршрутизации:**

- В зависимости от выбранного режима (L2 или BGP) настраивается конфигурация MetalLB.
- Для BGP требуется указать параметры соединения с внешними маршрутизаторами.

4. **Создание Сервисов LoadBalancer:**

- Разработчики могут создавать сервисы Kubernetes с типом `LoadBalancer`.
- MetalLB автоматически присваивает им IP-адреса и обеспечивает их доступность извне.

<Tabs>

    <TabItem value='IPAddressPool'>
        <MetallbL2Announce />
    </TabItem>

    <TabItem value='L2Advertisement'>
        <L2Advertisement />
    </TabItem>

</Tabs>
