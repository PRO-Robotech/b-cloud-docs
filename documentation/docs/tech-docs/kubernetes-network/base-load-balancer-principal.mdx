---
id: base-load-balancer-principal
---

import {getBasePrefix} from '@site/src/utils/getBasePrefix'

# Внутренняя балансировка

### Балансировка на уровне L2 (Текущая)

Балансировка нагрузки на уровне L2 является самым простым способом реализации и работает в любых средах без необходимости использования специальных маршрутизаторов. В данной конфигурации один из узлов Kubernetes берет на себя роль объявления службы остальной сети, действуя так, как будто к его сетевому интерфейсу добавлен вторичный IP-адрес.

В случае отказа узла, объявляющего службу, автоматически выбирается другой узел. Этот узел использует протоколы gratuitous ARP (Address Resolution Protocol) или NDP (Neighbor Discovery Protocol), чтобы уведомить остальную часть сети о новом расположении службы.

Следует отметить, что данный метод функционирует скорее как отказоустойчивость, а не как настоящая балансировка нагрузки. Поскольку IP-адрес может быть сопоставлен только с одним физическим (MAC) адресом в каждый момент времени, весь входящий трафик для службы проходит через один узел. Это может потенциально стать узким местом для некоторых служб, но в большинстве случаев не вызывает серьезных проблем.

### Балансировка с использованием BGP (Целевая)

Режим BGP, хотя и требует более сложной начальной настройки, позволяет избежать узкого места одного узла, характерного для уровня 2. Не позволяйте потенциальной сложности отпугнуть вас от его использования.

В этом режиме каждый узел Kubernetes превращается в маршрутизатор и объявляет маршруты к вашим сервисам своим одноранговым узлам. При условии, что ваши вышестоящие маршрутизаторы поддерживают мультипутевую маршрутизацию BGP, трафик будет распределяться относительно равномерно между всеми узлами, объявляющими ваш сервис.

Ключевая особенность режима BGP связана с тем, как в этом протоколе реализована балансировка нагрузки без сохранения состояния. Вместо отслеживания соединений BGP использует хеширование заголовков входящих пакетов (таких как IP-адреса и порты) для определения следующего перехода. Когда узлы добавляются или удаляются, существующие соединения могут быть случайным образом перераспределены на основе этого хеша. Это может привести к тому, что клиенты один раз получат ошибку сброса соединения при изменении состава узлов.

### Понимание того, как проходит трафик

Kubernetes поддерживает несколько моделей балансировки трафика

|                       | L2 балансировка                                                                             | BGP балансировка                                                                                        |
| --------------------- | ------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------- |
| Global traffic policy | Трафик входит в один узел и распределяется по всем подам, соответствующим селектору сервиса | Трафик распределяется по всем узлам и распределяется по всем подам, соответствующим селектору сервиса   |
| Local traffic policy  | Трафик входит в один узел и распределяется только по подам на этом же узле                  | Трафик распределяется по всем узлам с запущенными подами и затем распределяется по подам на том же узле |

### Сохранении IP-адреса источника

Сохранение IP-адреса источника является важным фактором при выборе политики внешнего трафика в Kubernetes. При использовании глобальной политики (`externalTrafficPolicy: Cluster`) IP-адрес источника входящих пакетов всегда преобразуется (даже если целевой Pod находится на том же узле). Это означает, что приложение, работающее за вашим Сервисом, не сможет определить IP-адрес клиента входящего запроса на основе сетевого соединения. Если у вас нет CDN или другого обратного прокси перед кластером, который может вставить IP-адрес клиента в HTTP-заголовок или использовать протокол PROXY, потеря истинного IP-адреса источника может быть значительным ограничением.

С другой стороны, локальная политика (`externalTrafficPolicy: Local`) сохраняет IP-адрес источника входящих пакетов. Единственным недостатком является то, что пакет может быть отправлен только на Pod/конечную точку, расположенную на том же узле.

### L2-балансировка `Global`

При использовании L2-балансировки совместно с глобальной политикой трафика, балансировщик объявляет MAC-адрес одного из узлов. CNI-плагин (`Cilium`) затем равномерно распределяет входящий трафик по всем конечным точкам сервиса внутри кластера. Этот метод обеспечивает достаточно равномерное распределение трафика, однако при этом теряется исходный IP-адрес клиента.

<div className="center">
  {' '}
  <img src={`${getBasePrefix()}img/network/l2-global.drawio.svg`} />
</div>

### L2-балансировка `Local`

Когда применяется L2-балансировка с локальной политикой трафика для внешнего трафика, входящий трафик направляется только на тот узел, где имеются активные конечные точки сервиса, и обслуживается только подами на этом узле. Балансировщик управляет этим процессом, гарантируя, что узлы без конечных точек сервиса не будут объявлять данный сервис. Таким образом, исключается ситуация, когда сервис объявляется с узла B, в то время как поды сервиса работают на узле A.

Если вы используете L2-балансировку для сервиса с одним приложением (один под или одна конечная точка), локальная политика трафика является отличным выбором. Однако для сервисов с несколькими конечными точками важно помнить, что входящий трафик всегда будет обслуживаться только подами на одном узле в данный момент времени.

<div className="center">
  {' '}
  <img src={`${getBasePrefix()}img/network/l2-local.drawio.svg`} />
</div>

### BGP-балансировка `Global`

При использовании BGP совместно с глобальной политикой трафика (Global Traffic Policy) входящий трафик направляется на все узлы кластера и затем распределяется по всем конечным точкам сервисов внутри кластера.

- Если узел становится недоступен, его BGP-сессия прекращается, и вышестоящие маршрутизаторы перераспределяют трафик между оставшимися узлами.
- В отличие от L2-балансировки, все узлы принимают входящий трафик, что полезно для высоконагруженных сервисов, когда требуется избежать перегрузки одного узла.
- Подобно L2-балансировке, глобальная политика обеспечивает потенциально лучшее распределение нагрузки за счёт отсутствия сохранения IP-адреса источника.

<div className="center">
  {' '}
  <img src={`${getBasePrefix()}img/network/bgp-global.drawio.svg`} />
</div>

### BGP-балансировка `Local`

При использовании BGP совместно с локальной политикой трафика (Local Traffic Policy) каждый узел, содержащий хотя бы одну конечную точку сервиса, самостоятельно объявляет маршруты и распределяет трафик к конечным точкам на том же узле.

- Это минимизирует дополнительные сетевые переходы и сохраняет IP-адрес источника.
- Однако важно учитывать распределение трафика при такой конфигурации:
  - Трафик равномерно распределяется между узлами, а затем перераспределяется между подами на каждом узле.
  - Если на некоторых узлах больше подов, чем на других, распределение может стать неравномерным.
- Возможные решения:
  - Использование политик анти-аффинности подов для равномерного распределения подов по узлам.
  - Следить за соответствующими обсуждениями и обновлениями, предлагающими решения с помощью BGP для выравнивания распределения трафика на основе количества конечных точек на каждом узле.

<div className="center">
  <img src={`${getBasePrefix()}img/network/bgp-local.drawio.svg`} />
</div>
